#!/bin/sh

echo "user: $(whoami)"

# Wait for network connection
echo "Waiting for internet connection..."
max_retries=30
count=0
while ! ping -c 1 8.8.8.8 >/dev/null 2>&1; do
    if [ "$count" -ge "$max_retries" ]; then
        echo "Error: Network timeout. Proceeding but installations may fail."
        break
    fi
    echo "Waiting for network... ($((count+1))/$max_retries)"
    sleep 2
    count=$((count+1))
done

##############################################################################################
##############################################################################################

# flatpaks
echo "Configuring flatpaks..."

remove_flatpak() {
    local app_id=$1
    if flatpak info "$app_id" >/dev/null 2>&1; then
        echo "Removing $app_id..."
        flatpak uninstall --delete-data "$app_id" -y
    fi
}

install_flatpak() {
    local app_id=$1
    local app_name=$2
    if flatpak info "$app_id" >/dev/null 2>&1; then
        echo "$app_name is already installed."
    else
        echo "Installing $app_name..."
        if flatpak install -y "$app_id"; then
            echo "Success: $app_name installed"
        else
            echo "Error: Failed to install $app_name. Proceeding with remainder of script..."
        fi
    fi
}

remove_flatpak "org.mozilla.firefox"
install_flatpak "md.obsidian.Obsidian" "Obsidian"

echo "Done installing flatpaks"

# steam
STEAM_AUTOSTART="$HOME/.config/autostart/steam.desktop"
if [ -f "$STEAM_AUTOSTART" ]; then
    echo "Fixing steam autostart..."
    sed -i '/^\[Desktop Entry\]/a Hidden=true' "$STEAM_AUTOSTART"
    echo "Done fixing steam"
else
    echo "Steam autostart file not found at $STEAM_AUTOSTART, skipping."
fi

##############################################################################################
##############################################################################################

echo "All done!!"