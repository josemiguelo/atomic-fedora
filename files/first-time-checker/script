#!/bin/sh

# Define paths
SETUP_MARKER="$HOME/.config/ublue/setup-done"
STEAM_AUTOSTART="$HOME/.config/autostart/steam.desktop"

echo "user: $(whoami)"

if test -e "$SETUP_MARKER"; then
  echo "This process has been already run"
  echo "first time checker has been run"
  sleep 3
  exit 0
else
  echo "Starting first-time-checker script"
fi

# Wait for network connection
echo "Waiting for internet connection..."
max_retries=30
count=0
while ! ping -c 1 8.8.8.8 >/dev/null 2>&1; do
    if [ "$count" -ge "$max_retries" ]; then
        echo "Error: Network timeout. Proceeding but installations may fail."
        break
    fi
    echo "Waiting for network... ($((count+1))/$max_retries)"
    sleep 2
    count=$((count+1))
done

##############################################################################################
##############################################################################################

# flatpaks
echo "Configuring flatpaks..."

if flatpak info org.mozilla.firefox >/dev/null 2>&1; then
    echo "Removing Firefox..."
    flatpak uninstall --delete-data org.mozilla.firefox -y
fi

# Install Obsidian (critical)
if flatpak info md.obsidian.Obsidian >/dev/null 2>&1; then
    echo "Obsidian is already installed."
else
    echo "Installing Obsidian..."
    if flatpak install -y md.obsidian.Obsidian; then
        echo "Success: Obsidian installed"
    else
        echo "Error: Failed to install Obsidian. Proceeding with remainder of script..."
    fi
fi

echo "Done installing flatpaks"

# steam
if [ -f "$STEAM_AUTOSTART" ]; then
    echo "Fixing steam autostart..."
    sed -i '/^\[Desktop Entry\]/a Hidden=true' "$STEAM_AUTOSTART"
    echo "Done fixing steam"
else
    echo "Steam autostart file not found at $STEAM_AUTOSTART, skipping."
fi

##############################################################################################
##############################################################################################

echo "Finishing first-time-checker script"

# Create marker
mkdir -p "$(dirname "$SETUP_MARKER")"
touch "$SETUP_MARKER"
echo "Created setup marker."

echo "All done!"
read -p "Press Enter to close this window..."