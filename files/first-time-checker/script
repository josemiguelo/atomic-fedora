#!/bin/sh

CURRENT_USER=$(whoami)
if [ "$CURRENT_USER" = "sddm" ]; then
    echo "User is sddm, skipping first-time-checker..."
    exit 0
fi

echo "user: $CURRENT_USER"

# Wait for network connection
echo "Waiting for internet connection..."
max_retries=30
count=0
while ! ping -c 1 8.8.8.8 >/dev/null 2>&1; do
    if [ "$count" -ge "$max_retries" ]; then
        echo "Error: Network timeout. Proceeding but installations may fail."
        break
    fi
    echo "Waiting for network... ($((count+1))/$max_retries)"
    sleep 2
    count=$((count+1))
done

remove_flatpak() {
    local app_id=$1
    if flatpak info "$app_id" >/dev/null 2>&1; then
        echo "Removing $app_id..."
        flatpak uninstall --delete-data "$app_id" -y
    else
        echo "$app_id flatpak is not present on the system. skipping uninstallation..."
    fi
}

install_flatpak() {
    local app_id=$1
    local app_name=$2
    if flatpak info "$app_id" >/dev/null 2>&1; then
        echo "$app_name is already installed."
    else
        echo "Installing $app_name..."
        if flatpak install -y "$app_id"; then
            echo "Success: $app_name installed"
        else
            echo "Error: Failed to install $app_name. Proceeding with remainder of script..."
        fi
    fi
}

##############################################################################################
##############################################################################################

# flatpaks
echo "Configuring flatpaks..."
remove_flatpak "org.mozilla.firefox"
install_flatpak "md.obsidian.Obsidian" "Obsidian"
echo "Done installing flatpaks"

# steam
STEAM_AUTOSTART="$HOME/.config/autostart/steam.desktop"
if [ -f "$STEAM_AUTOSTART" ]; then
    echo "Fixing steam autostart..."
    sed -i '/^\[Desktop Entry\]/a Hidden=true' "$STEAM_AUTOSTART"
    echo "Done fixing steam"
else
    echo "Steam autostart file not found at $STEAM_AUTOSTART, skipping."
fi

# SSH key
SSH_KEY="$HOME/.ssh/bazzite"
if [ ! -f "$SSH_KEY" ]; then
    echo "Creating SSH key 'bazzite'..."
    ssh-keygen -t ed25519 -C "josemiguelo.ochoa@gmail.com" -f "$SSH_KEY" -N ""
    ssh-add "$SSH_KEY"
    echo "Done creating SSH key 'bazzite'"
else
    echo "SSH key 'bazzite' already exists."
fi


##############################################################################################
##############################################################################################

echo "All done!!"